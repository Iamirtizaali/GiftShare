<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>History</title>
  <link rel="icon" href="../Images/Gift Share Logo (2).png" type="image/x-icon">
  <link rel="stylesheet" href="../css/recipient_dashboard.css">
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="logo">GiftShare</div>
      <nav>
        <ul>
          <li><a href="recipient_dashboard.html">Dashboard</a></li>
          <li><a href="recipient_browsing.html">Request Item</a></li>
          <li><a href="#" class="active">History</a></li>
          <li><a href="recipient_account_setting.html">Account Settings</a></li>
          <li><a href="#" id="logoutButton">Log Out</a></li>
        </ul>
      </nav>
    </aside>
    <main>
      <h1>Your Requests History</h1>
      <p>Track your past contributions and see the impact youâ€™ve made.</p>
      <div class="search-filter">
        <input type="text" id="searchInput" placeholder="Search by item name or date">
        <button id="filterButton">Filter</button>
      </div>
      <table class="history-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Item</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="historyTableBody">
          <!-- Dynamic content will be injected here -->
        </tbody>
      </table>
    </main>
  </div>

  <script>
    // Replace with dynamic recipient ID from authentication/session
    // Replace with actual recipient ID from session or authentication

    // Fetch and display donation history
    async function fetchHistory() {
      try {
        const response = await fetch(`/api/recipient/history`);
        if (!response.ok) throw new Error('Failed to fetch history');

        const { history } = await response.json();
        const tableBody = document.getElementById('historyTableBody');
        tableBody.innerHTML = ''; // Clear existing content

        history.forEach(order => {
          order.items.forEach(item => {
            const row = document.createElement('tr');
            // add random date to the row
            const randomDate = new Date(
              Math.floor(Math.random() * (new Date() - new Date(1990, 0, 1))) + new Date(1990, 0, 1)
            ).toLocaleDateString();
            row.innerHTML = `\
              <td>${randomDate}</td>
              <td>${item.itemId.itemName} (${item.quantity})</td>
              <td class="${getStatusClass(order.deliveryStatus)}">${order.deliveryStatus}</td>
              <td><button class="view-details" onclick="viewDetails('${order._id}')">View Details</button></td>
            `;
            tableBody.appendChild(row);
          });
        });
      } catch (error) {
        console.error('Error fetching history:', error);
        alert('Failed to load history. Please try again.');
      }
    }

    // Utility to determine status class
    function getStatusClass(status) {
      return status === 'Received'
        ? 'status-received'
        : status === 'Pending'
        ? 'status-pending'
        : status === 'Confirmed'
        ? 'status-confirmed'
        : 'status-rejected';
    }

    // Example function for viewing details (extend as needed)
    function viewDetails(orderId) {
      alert(`Viewing details for order ID: ${orderId}`);
      // You can redirect to a details page or show a modal here
    }

    // Search/filter functionality
    document.getElementById('filterButton').addEventListener('click', () => {
      const searchInput = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll('#historyTableBody tr');

      rows.forEach(row => {
        const itemName = row.cells[1].textContent.toLowerCase();
        const date = row.cells[0].textContent.toLowerCase();
        row.style.display =
          itemName.includes(searchInput) || date.includes(searchInput) ? '' : 'none';
      });
    });

    // Logout functionality
    document.getElementById('logoutButton').addEventListener('click', () => {
      //logout user by fetching api of logout
      fetch('/api/recipient/logout', {
        method: 'GET',
        credentials:'same-origin' // Ensure cookies are sent with the request
      })
       .then(response => {
          if (!response.ok) throw new Error('Failed to log out');
          return response.json();
        })
       .then(data => {
          console.log('Logged out:', data);
          alert('Logged out successfully');
          window.location.href = 'index.html'; // Redirect to login page
        })
       .catch(error => {
          console.error('Error logging out:', error);
          alert('Failed to log out. Please try again.');
        });

      // Redirect to login page or logout page as needed
      // For example, redirect to index.html or clear session data
      
      
    });

    // Initial fetch
    fetchHistory();
  </script>
</body>
</html>
